# This file tells GitHub how to build your plugin.
# It must go in a folder named .github/workflows/ at the root of your project.

name: Build Minecraft Plugin

on:
  # This workflow runs when you create a new "release" on GitHub
  # that has a tag starting with 'v' (like v1.0.0)
  release:
    types: [published]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # 1. Check out your code
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Set up Java (use Java 17 as in your original file)
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'gradle'

      # 3. Make the Gradle wrapper executable
      - name: Ensure gradlew is executable
        run: chmod +x ./gradlew

      # 4. Build the plugin using Gradle.
      # Many plugins use 'shadowJar' to include dependencies.
      # If you just use 'build', change 'shadowJar' to 'build'.
      - name: Build with Gradle
        run: ./gradlew shadowJar
        env:
          JAVA_TOOL_OPTIONS: -Xmx2g

      # 5. Find the built .jar file
      # It searches in build/libs/ for a .jar file that isn't 'sources' or 'javadoc'.
      - name: Find plugin .jar
        id: find_jar
        run: |
          JAR_FILE=$(find build/libs -maxdepth 1 -type f -name "*.jar" ! -name "*sources*" ! -name "*javadoc*" | head -n 1)
          if [ -z "$JAR_FILE" ]; then
            echo "No .jar file found in build/libs/"
            exit 1
          fi
          echo "Found jar: $JAR_FILE"
          echo "jar_path=$JAR_FILE" >> $GITHUB_OUTPUT
          echo "jar_name=$(basename "$JAR_FILE")" >> $GITHUB_OUTPUT

      # 6. Upload the .jar file to the GitHub Release page
      - name: Upload .jar to Release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          # This is the URL for uploading found in the release event
          upload_url: ${{ github.event.release.upload_url }}
          # This is the path to the file we found in the previous step
          asset_path: ${{ steps.find_jar.outputs.jar_path }}
          # This is the name it will have on the release page
          asset_name: ${{ steps.find_jar.outputs.jar_name }}
          asset_content_type: application/java-archive
